version: "3.9"

services:
  # SERVIÇOS EXISTENTES

  exporter:
    build:
      context: ./exporter
    container_name: obs-node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    volumes:
      - /:/host:ro,rslave
      - ./exporter/textfile:/etc/node-exporter/textfile
    environment:
      - NODE_EXPORTER_FLAGS=

  ping-exporter:
    image: czerwonk/ping_exporter:latest
    container_name: obs-ping-exporter
    restart: unless-stopped
    cap_add:
      - NET_RAW
    environment:
      - CONFIG_FILE=/config/ping_exporter.yml
    ports:
      - "9427:9427"
    volumes:
      - ./ping-exporter/ping_exporter.yml:/config/ping_exporter.yml:ro
    depends_on:
      - exporter

  prometheus:
    build:
      context: ./prometheus
    image: obs-prometheus
    container_name: obs-prometheus
    restart: unless-stopped
    depends_on:
      - exporter
      - ping-exporter
      - mysql-exporter # NOVO: Dependência do MySQL Exporter
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus

  grafana:
    build:
      context: ./grafana
    image: obs-grafana
    container_name: obs-grafana
    restart: unless-stopped
    ports:
      - "3300:3000" # Porta 3300 para acesso direto ao Grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus
      - nginx # NOVO: Dependência do Nginx (opcional, para garantir ordem)
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro

  # NOVOS SERVIÇOS DE BANCO DE DADOS E CARGA

  # 1. Banco de Dados Relacional (MySQL)
  mysql:
    image: mysql:8.0
    container_name: obs-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: desafio_db
    volumes:
      - mysql-data:/var/lib/mysql # Persistência
      - ./db_init/init.sql:/docker-entrypoint-initdb.d/init.sql # Script de inicialização
    restart: always

  # 2. Database Exporter (MySQL Exporter)
  mysql-exporter:
    image: prom/mysqld-exporter:latest
    container_name: obs-mysql-exporter
    environment:
      # Conexão: user:password@(host:port)/database
      DATA_SOURCE_NAME: user:password@(mysql:3306)/desafio_db
    restart: always
    depends_on:
      - mysql
    # A porta 9104 é o endpoint de métricas que o Prometheus irá raspar.

  # 3. Gerador de Carga (Python/PyMySQL)
  load-generator:
    build: ./load_generator # Requer Dockerfile, requirements.txt e load_generator.py na pasta
    container_name: obs-load-generator
    restart: always
    depends_on:
      - mysql # Garante que o banco suba primeiro
  
  # 4. Camada de Autenticação (Nginx Reverse Proxy)
  nginx:
    image: nginx:alpine
    container_name: obs-nginx-proxy
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro # Configuração do Nginx
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro # Arquivo de senha
    ports:
      - "443:443" # Porta de acesso seguro/autenticado
    depends_on:
      - grafana 
    restart: unless-stopped

volumes:
  prometheus-data:
  grafana-data:
  mysql-data: # NOVO: Volume para persistência do MySQL