version: "3.9"

services:
  # SERVIÇOS DE MONITORAMENTO EXISTENTES
  
  exporter:
    build:
      context: ./exporter
    container_name: obs-node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    volumes:
      - /:/host:ro,rslave
      - ./exporter/textfile:/etc/node-exporter/textfile
    environment:
      - NODE_EXPORTER_FLAGS=

  ping-exporter:
    image: czerwonk/ping_exporter:latest
    container_name: obs-ping-exporter
    restart: unless-stopped
    cap_add:
      - NET_RAW
    environment:
      - CONFIG_FILE=/config/ping_exporter.yml
    ports:
      - "9427:9427"
    volumes:
      - ./ping-exporter/ping_exporter.yml:/config/ping_exporter.yml:ro
    depends_on:
      - exporter

  prometheus:
    build:
      context: ./prometheus
    image: obs-prometheus
    container_name: obs-prometheus
    restart: unless-stopped
    depends_on:
      - exporter
      - ping-exporter
      - mysql-exporter # Dependência do MySQL Exporter
    ports:
      - "9090:9090"
    volumes:
      - prometheus-data:/prometheus

  grafana:
    build:
      context: ./grafana
    image: obs-grafana
    container_name: obs-grafana
    restart: unless-stopped
    ports:
      - "3300:3000" # Porta de acesso direto ao Grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    # DEPENDÊNCIA CORRIGIDA: Não depende do Nginx para evitar o ciclo.
    depends_on:
      - prometheus
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro

  # NOVOS SERVIÇOS (MYSQL E CARGA)
  
  mysql:
    image: mysql:8.0
    container_name: obs-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_DATABASE: desafio_db
    volumes:
      - mysql-data:/var/lib/mysql 
      - ./db_init/init.sql:/docker-entrypoint-initdb.d/init.sql 
    restart: always

  mysql-exporter:
    image: prom/mysqld-exporter:latest
    container_name: obs-mysql-exporter
    environment:
      # Credenciais para o Exporter
      DATA_SOURCE_NAME: user:password@(mysql:3306)/desafio_db
    restart: always
    depends_on:
      - mysql
    command: sh -c "sleep 10 && /bin/mysqld_exporter"
    # Prometheus faz o scrape interno na porta 9104

  load-generator:
    build: ./load_generator 
    container_name: obs-load-generator
    restart: always
    depends_on:
      - mysql # Garante que o banco suba antes do gerador de carga
  
  # CAMADA DE SEGURANÇA (NGINX REVERSE PROXY)

  nginx:
    image: nginx:alpine
    container_name: obs-nginx-proxy
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro # Configuração
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro # Autenticação
    ports:
      - "443:443" # Porta de acesso autenticado (HTPASSWD)
    depends_on:
      - grafana # Nginx espera o Grafana estar pronto para fazer o proxy
    restart: unless-stopped

# VOLUMES
volumes:
  prometheus-data:
  grafana-data:
  mysql-data: # Volume para persistência do MySQL