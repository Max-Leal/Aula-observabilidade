version: "3.9"

services:
  # 1. Exporter Padrão do Host (Node Exporter)
  exporter:
    build:
      context: ./exporter
    container_name: obs-node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    volumes:
      # Monta o sistema de arquivos raiz do host para coletar métricas do SO
      - /:/host:ro,rslave 
      - ./exporter/textfile:/etc/node-exporter/textfile
    command:
      # Garante a coleta de métricas do sistema de arquivos
      - '--path.rootfs=/host'
    networks:
      - monitor-net

  # 2. Exporter de Latência de Rede (Ping Exporter)
  ping-exporter:
    image: czerwonk/ping_exporter:latest
    container_name: obs-ping-exporter
    restart: unless-stopped
    # NET_RAW é necessário para executar o ping dentro do contêiner
    cap_add:
      - NET_RAW 
    environment:
      - CONFIG_FILE=/config/ping_exporter.yml
    ports:
      - "9427:9427"
    volumes:
      - ./ping-exporter/ping_exporter.yml:/config/ping_exporter.yml:ro
    depends_on:
      - exporter
    networks:
      - monitor-net

  # 3. Servidor de Banco de Dados MySQL
  mysql:
    image: mysql:8.0
    container_name: obs-mysql
    restart: always
    environment:
      # Credenciais obrigatórias para inicialização do MySQL
      MYSQL_ROOT_PASSWORD: root_pass
      MYSQL_DATABASE: app_db
      MYSQL_USER: myuser
      MYSQL_PASSWORD: mypass
    ports:
      - "3306:3306"
    volumes:
      # Persistência de dados do MySQL
      - mysql-data:/var/lib/mysql 
    networks:
      - monitor-net

  # 4. Exporter Específico para MySQL (mysqld-exporter)
  mysql_exporter:
    image: prom/mysqld-exporter
    container_name: obs-mysql-exporter
    restart: always
    environment:
      # String de conexão do exporter. Usa o nome do serviço 'mysql' como hostname
      DATA_SOURCE_NAME: "myuser:mypass@(mysql:3306)/app_db"
    ports:
      - "9104:9104"
    depends_on:
      - mysql
    networks:
      - monitor-net
      
  # 5. Prometheus - Coletor e Armazenador
  prometheus:
    build:
      context: ./prometheus
    image: obs-prometheus
    container_name: obs-prometheus
    restart: unless-stopped
    depends_on:
      - exporter
      - ping-exporter
      - mysql_exporter # Dependência no MySQL Exporter
    ports:
      - "9090:9090"
    volumes:
      # Volume para persistência das métricas do Prometheus
      - prometheus-data:/prometheus 
    networks:
      - monitor-net

  # 6. Grafana - Visualização
  grafana:
    build:
      context: ./grafana
    image: obs-grafana
    container_name: obs-grafana
    restart: unless-stopped
    ports:
      - "3300:3000"
    environment:
      # Credenciais de acesso ao Grafana
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus
    volumes:
      - grafana-data:/var/lib/grafana
      # Provisão de fontes de dados e dashboards
      - ./grafana/provisioning:/etc/grafana/provisioning:ro 
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - monitor-net

volumes:
  prometheus-data:
  grafana-data:
  mysql-data: # Volume nomeado para persistência do MySQL

networks:
  monitor-net:
    driver: bridge